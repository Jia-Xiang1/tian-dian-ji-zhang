<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>甜點記帳 PWA</title>
<link rel="manifest" href="manifest.json">
<style>
body {
  font-family: Arial, sans-serif;
  max-width:700px;
  margin:auto;
  padding:16px;
  background:#f2f2f7;
}

/* 輸入區塊 */
.form-card {
  background:#fff;
  border-radius:14px;
  padding:12px;
  margin-bottom:12px;
  box-shadow:0 2px 6px rgba(0,0,0,0.1);
  font-size:1.4em;
}

/* 日期 / 份數 */
#dateInput, #qtyInput { font-size:1.2em; padding:10px; width:100%; box-sizing:border-box; text-align:center; }

/* 商品選單 */
#productSelect { font-size:1.2em; padding:10px; width:100%; box-sizing:border-box; text-align:center; }

/* 新增按鈕 */
#addBtn { font-size:1.2em; padding:12px; width:100%; box-sizing:border-box; border:none; border-radius:12px; background:#007aff; color:#fff; cursor:pointer; }

/* 表格外包容器，可橫向滑動 */
#tableWrapper { overflow-x:auto; margin-top:20px; }

/* 表格 */
table { width:100%; border-collapse:collapse; min-width:650px; }
th, td { border:1px solid #ccc; padding:6px; text-align:center; }
th { background:#f0f0f0; }

/* 今日統計 */
#totals {
  font-size:1.2em;
  padding:12px;
  background:#fff;
  border-radius:14px;
  box-shadow:0 2px 6px rgba(0,0,0,0.1);
  margin-top:10px;
}

/* 後台密碼與管理 */
#backendWrapper { display:none; margin-top:12px; background:#fff; border-radius:14px; padding:12px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }

button { cursor:pointer; }
</style>
</head>
<body>

<h2>甜點銷售記帳</h2>

<!-- 前台輸入 -->
<div class="form-card">
  日期<br>
  <input type="date" id="dateInput">
</div>

<div class="form-card">
  商品<br>
  <select id="productSelect"></select>
</div>

<div class="form-card">
  份數<br>
  <input type="number" id="qtyInput" min="1" value="1">
</div>

<div class="form-card">
  <button id="addBtn">新增</button>
</div>

<!-- 表格 -->
<div id="tableWrapper">
  <table id="salesTable">
    <thead>
      <tr>
        <th>日期</th>
        <th>商品</th>
        <th>份數</th>
        <th>成本</th>
        <th>售價</th>
        <th>收入</th>
        <th>利潤</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- 今日統計 -->
<div id="totals">
  <strong>今日總成本：</strong><span id="totalCost">0</span> 元<br>
  <strong>今日總收入：</strong><span id="totalRevenue">0</span> 元<br>
  <strong>今日總利潤：</strong><span id="totalProfit">0</span> 元
</div>

<!-- 後台密碼 -->
<div class="form-card">
  <input type="password" id="adminPassword" placeholder="輸入後台密碼">
  <button id="unlockBtn">進入後台</button>
</div>

<!-- 後台管理 -->
<div id="backendWrapper">
  <h3>後台設定成本與售價</h3>
  <div id="backendProducts"></div>
  <div style="margin-top:10px;">
    新增商品：
    <input type="text" id="newProductName" placeholder="名稱">
    成本 <input type="number" id="newProductCost" placeholder="成本">
    售價 <input type="number" id="newProductPrice" placeholder="售價">
    <button id="addProductBtn">新增商品</button>
  </div>
</div>

<script>
// ===== 初始商品 =====
let products = JSON.parse(localStorage.getItem('products')) || [
  {name:'雞蛋糕', price:50, cost:20},
  {name:'奶酪杯', price:60, cost:25},
  {name:'提拉米蘇杯', price:70, cost:30},
  {name:'雪媚娘', price:55, cost:25},
  {name:'紅糖糍粑', price:40, cost:15},
  {name:'奶茶凍', price:50, cost:20},
  {name:'桂花奶酪', price:60, cost:25},
  {name:'華夫餅', price:65, cost:30}
];
let salesRecords = JSON.parse(localStorage.getItem('salesRecords')) || [];

// ===== 更新商品選單 =====
function updateProductSelect(){
  const select = document.getElementById('productSelect');
  select.innerHTML='';
  products.forEach((p,i)=>{
    const opt = document.createElement('option');
    opt.value=i;
    opt.innerText=p.name;
    select.appendChild(opt);
  });
}
updateProductSelect();

// ===== 渲染銷售 =====
function renderSales(){
  const tbody = document.querySelector('#salesTable tbody');
  tbody.innerHTML='';
  let totalCost=0, totalRevenue=0, totalProfit=0;
  const today = document.getElementById('dateInput').value;

  salesRecords.forEach((r, idx)=>{
    const p = products[r.productIndex];
    const revenue = p.price * r.qty;
    const profit = revenue - (p.cost * r.qty);
    totalCost += r.date === today ? p.cost*r.qty : 0;
    totalRevenue += r.date === today ? revenue : 0;
    totalProfit += r.date === today ? profit : 0;

    const dateStr = new Date(r.date).toLocaleDateString('zh-TW', {month:'numeric', day:'numeric'});
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${dateStr}</td>
      <td style="text-align:center;">${p.name}</td>
      <td>${r.qty}</td>
      <td>${p.cost}</td>
      <td>${p.price}</td>
      <td>${revenue}</td>
      <td>${profit}</td>
      <td><button onclick="deleteSale(${idx})">刪除</button></td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById('totalCost').innerText = totalCost;
  document.getElementById('totalRevenue').innerText = totalRevenue;
  document.getElementById('totalProfit').innerText = totalProfit;
}

// ===== 新增銷售 =====
document.getElementById('addBtn').addEventListener('click', ()=>{
  const date = document.getElementById('dateInput').value;
  const productIndex = parseInt(document.getElementById('productSelect').value);
  const qty = parseInt(document.getElementById('qtyInput').value);

  if(!date || isNaN(qty) || qty<=0) return alert('請輸入完整資訊');
  salesRecords.push({date, productIndex, qty});
  localStorage.setItem('salesRecords', JSON.stringify(salesRecords));
  renderSales();
  document.getElementById('qtyInput').value = 1;
});

// ===== 刪除銷售 =====
function deleteSale(idx){
  if(confirm('確定刪除這筆銷售紀錄？')){
    salesRecords.splice(idx,1);
    localStorage.setItem('salesRecords', JSON.stringify(salesRecords));
    renderSales();
  }
}

// ===== 後台密碼 =====
const correctPassword = "1234";
document.getElementById('unlockBtn').addEventListener('click', ()=>{
  const pwd = document.getElementById('adminPassword').value;
  if(pwd===correctPassword){
    document.getElementById('backendWrapper').style.display='block';
    document.getElementById('adminPassword').value='';
    renderBackend();
    alert('後台已開啟！');
  } else alert('密碼錯誤！');
});

// ===== 後台渲染商品 =====
function renderBackend(){
  const container = document.getElementById('backendProducts');
  container.innerHTML='';
  products.forEach((p,i)=>{
    const div = document.createElement('div');
    div.style.marginBottom='6px';
    div.innerHTML = `
      ${p.name} 成本 <input type="number" value="${p.cost}" onchange="updateProduct(${i}, 'cost', this.value)">
      售價 <input type="number" value="${p.price}" onchange="updateProduct(${i}, 'price', this.value)">
      <button onclick="deleteProduct(${i})">刪除</button>
    `;
    container.appendChild(div);
  });
}

// ===== 更新商品 =====
function updateProduct(idx, field, value){
  value = parseFloat(value);
  products[idx][field]=value;
  localStorage.setItem('products', JSON.stringify(products));
  updateProductSelect();
  renderSales();
  renderBackend();
}

// ===== 刪除商品 =====
function deleteProduct(idx){
  if(confirm('確定刪除此商品？')){
    products.splice(idx,1);
    localStorage.setItem('products', JSON.stringify(products));
    updateProductSelect();
    renderSales();
    renderBackend();
  }
}

// ===== 新增商品 =====
document.getElementById('addProductBtn').addEventListener('click', ()=>{
  const name = document.getElementById('newProductName').value.trim();
  const cost = parseFloat(document.getElementById('newProductCost').value);
  const price = parseFloat(document.getElementById('newProductPrice').value);
  if(!name || isNaN(cost) || isNaN(price)) return alert('請填寫完整商品資訊');
  products.push({name, cost, price});
  localStorage.setItem('products', JSON.stringify(products));
  updateProductSelect();
  renderBackend();
  document.getElementById('newProductName').value='';
  document.getElementById('newProductCost').value='';
  document.getElementById('newProductPrice').value='';
});

// ===== 初始渲染 =====
renderSales();
</script>

</body>
</html>
