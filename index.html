<script type="module">
let username = "";
let products = [];
let sales = [];

// 你的 Apps Script Web App URL
const API_URL = "https://script.google.com/macros/s/AKfycbw0QVEItm5QURDKkUqZcViscC55yxL_vHJ2MGKdla-U85whhF2J8CFrKOJugrftumCjaQ/exec";

/* ---------------- 使用者登入 ---------------- */
window.login = async function() {
  const name = document.getElementById("usernameInput").value.trim();
  if (!name) return alert("請輸入姓名");
  username = name;
  document.getElementById("loginCard").style.display = "none";
  document.getElementById("tabs").style.display = "flex";
  showTab('frontend');
  await loadProducts();
  await loadSales();
}

/* ---------------- 分頁切換 ---------------- */
window.showTab = function(tab) {
  document.getElementById("frontend").style.display = tab === 'frontend' ? 'block' : 'none';
  document.getElementById("backend").style.display = tab === 'backend' ? 'block' : 'none';
}

/* ---------------- 讀取商品 ---------------- */
async function loadProducts() {
  const res = await fetch(`${API_URL}?type=products`);
  products = await res.json();
  updateSelect();
  renderBackend();
}

function updateSelect() {
  const s = document.getElementById("productSelect");
  s.innerHTML = "";
  products.forEach(p => {
    const o = document.createElement("option");
    o.value = p.name; // 用名稱當 ID
    o.textContent = p.name;
    s.appendChild(o);
  });
}

/* ---------------- 讀取銷售 ---------------- */
async function loadSales() {
  const res = await fetch(`${API_URL}?type=sales`);
  sales = await res.json();
  renderSales();
}

/* ---------------- 新增銷售 ---------------- */
window.addSale = async function() {
  const d = document.getElementById("dateInput").value;
  const productName = document.getElementById("productSelect").value;
  const q = parseInt(document.getElementById("qtyInput").value);
  if (!d || !productName || q <= 0) return alert("請完整填寫");

  const p = products.find(p => p.name === productName);
  if (!p) return alert("商品不存在");

  const revenue = p.price * q;

  await fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({ type: "sale", date: d, product: productName, qty: q, user: username, revenue }),
    headers: { "Content-Type": "application/json" }
  });

  loadSales();
}

/* ---------------- 渲染銷售表格 ---------------- */
function renderSales() {
  const list = document.getElementById("salesList");
  list.innerHTML = "";
  let totalCost = 0, totalRevenue = 0;

  sales.forEach(s => {
    const p = products.find(p => p.name === s.product);
    if (!p) return;
    totalCost += p.cost * s.qty;
    totalRevenue += s.revenue;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${s.date.slice(5)}</td>
      <td>${s.product}</td>
      <td>${s.qty}</td>
      <td>${s.revenue}</td>
      <td>${s.user}</td>
      <td><button onclick="delSale('${s.date}','${s.product}','${s.user}')">刪除</button></td>`;
    list.appendChild(tr);
  });

  document.getElementById("totalCost").textContent = totalCost;
  document.getElementById("totalRevenue").textContent = totalRevenue;
  document.getElementById("totalProfit").textContent = totalRevenue - totalCost;
}

/* ---------------- 刪除銷售 ---------------- */
window.delSale = async function(date, product, user) {
  if (!confirm("確定刪除這筆銷售？")) return;
  await fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({ type: "deleteSale", date, product, user }),
    headers: { "Content-Type": "application/json" }
  });
  loadSales();
}

/* ---------------- 後台 ---------------- */
function renderBackend() {
  const box = document.getElementById("productList");
  box.innerHTML = "";
  products.forEach(p => {
    const d = document.createElement("div");
    d.className = "product-card";
    d.innerHTML = `
      <div style="margin-bottom:6px; font-weight:bold;">${p.name}</div>
      <div class="product-row">
        <div style="flex:1; text-align:center;">成本<input value="${p.cost}" onchange="updateP('${p.name}','cost',this.value)"></div>
        <div style="flex:1; text-align:center;">售價<input value="${p.price}" onchange="updateP('${p.name}','price',this.value)"></div>
      </div>
      <button onclick="delProduct('${p.name}')" style="margin-top:6px;">刪除商品</button>`;
    box.appendChild(d);
  });
}

/* ---------------- 更新商品 ---------------- */
window.updateP = async function(name, field, value) {
  await fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({ type: "updateProduct", name, field, value: parseFloat(value) }),
    headers: { "Content-Type": "application/json" }
  });
  loadProducts();
}

/* ---------------- 刪除商品 ---------------- */
window.delProduct = async function(name) {
  if (!confirm("確定刪除商品？")) return;
  await fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({ type: "deleteProduct", name }),
    headers: { "Content-Type": "application/json" }
  });
  loadProducts();
}

/* ---------------- 新增商品 ---------------- */
window.addProduct = async function() {
  const n = document.getElementById("newName").value.trim();
  const c = parseFloat(document.getElementById("newCost").value);
  const p = parseFloat(document.getElementById("newPrice").value);
  if (!n || isNaN(c) || isNaN(p)) return alert("請完整填寫商品資訊");

  await fetch(API_URL, {
    method: "POST",
    body: JSON.stringify({ type: "product", name: n, cost: c, price: p }),
    headers: { "Content-Type": "application/json" }
  });

  document.getElementById("newName").value = "";
  document.getElementById("newCost").value = "";
  document.getElementById("newPrice").value = "";
  loadProducts();
}
</script>
