<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>甜點銷售記帳</title>
<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, Arial;
  background:#f2f2f7;
  max-width:700px;
  margin:auto;
  padding:16px;
}

/* 通用卡片 */
.card {
  background:#fff;
  border-radius:14px;
  padding:12px;
  margin-bottom:14px;
  box-shadow:0 2px 8px rgba(0,0,0,0.08);
  text-align:center;
}

/* 所有輸入安全設定 */
input, select, button {
  font-size:16px;
  height:44px;
  width:100%;
  box-sizing:border-box;
  border:none;
  border-radius:12px;
  background:#f2f2f7;
  text-align:center;
}

/* 日期輸入框縮小、置中，底色白、無框線 */
#dateInput {
  background: #fff;   
  border: none;       
  width: 60%;         
  max-width: 300px;   
  margin: 0 auto;     
  display: block;     
  text-align: center; 
  height: 32px;       
  line-height: 32px;  
  border-radius: 8px; 
}

/* 商品選擇欄文字置中 */
#productSelect {
  width: 60%;
  max-width: 300px;
  margin: 0 auto;
  display: block;
  text-align-last: center;
  -moz-text-align-last: center;
  -webkit-appearance: none;
  appearance: none;
  height: 32px;
  border-radius: 8px;
  background: #fff;
}

/* 代號輸入欄 */
#userCodeInput {
  width: 60%;
  max-width: 200px;
  display:inline-block;
  text-align:center;
  height:32px;
  line-height:32px;
  border-radius:8px;
  margin-right:10px;
}

/* 按鈕 */
button {
  background:#007aff;
  color:#fff;
}

/* 表格 */
table {
  width:100%;
  border-collapse:collapse;
}
th, td {
  border:1px solid #ccc;
  padding:6px;
  text-align:center; 
}
th {
  background:#f0f0f0;
}

/* 後台密碼列 */
.admin-row {
  display:flex;
  gap:10px;
}
.admin-row input,
.admin-row button {
  flex:1;
}

/* 後台商品卡片 */
.product-card {
  border:1px solid #ddd;
  border-radius:12px;
  padding:10px;
  margin-bottom:10px;
}

/* 商品成本/售價列 */
.product-row {
  display:flex;
  justify-content:space-between;
  gap:4%;
}
.product-row div input {
  width:100%;
  margin-top:4px;
}

/* 今日統計固定 */
#stats {
  text-align:center;
  font-weight:bold;
  margin-bottom:14px;
}
</style>
</head>
<body>

<h2 style="text-align:center">甜點銷售記帳</h2>

<!-- 代號登入 -->
<div class="card" id="loginCard">
  代號：
  <input type="text" id="userCodeInput" placeholder="輸入代號">
  <button onclick="login()">進入系統</button>
</div>

<!-- 主畫面 -->
<div id="mainScreen" style="display:none;">

  <!-- 日期 -->
  <div class="card">
    日期
    <input type="date" id="dateInput">
  </div>

  <!-- 商品 -->
  <div class="card">
    商品
    <select id="productSelect"></select>
  </div>

  <!-- 份數 -->
  <div class="card">
    份數
    <input type="number" id="qtyInput" min="1" value="1">
  </div>

  <!-- 新增 -->
  <div class="card">
    <button onclick="addSale()">新增銷售</button>
  </div>

  <!-- 銷售表格 -->
  <div class="card">
    <table>
      <thead>
        <tr>
          <th>日期</th><th>商品</th><th>份數</th><th>收入</th><th>代號</th><th>刪除</th>
        </tr>
      </thead>
      <tbody id="salesList"></tbody>
    </table>
  </div>

  <!-- 今日統計 -->
  <div id="stats" class="card">
    今日成本：<span id="totalCost">0</span> ｜ 
    今日收入：<span id="totalRevenue">0</span> ｜ 
    今日利潤：<span id="totalProfit">0</span>
  </div>

  <!-- 後台密碼 -->
  <div class="card">
    <div class="admin-row">
      <input type="password" id="adminPwd" placeholder="後台密碼">
      <button onclick="unlockBackend()">進入後台</button>
    </div>
  </div>

  <!-- 後台 -->
  <div id="backend" style="display:none" class="card">
    <h3>商品管理</h3>
    <div id="productList"></div>

    <!-- 新增商品區 -->
    <div class="product-card">
      <div style="margin-bottom:6px; font-weight:bold;">新增商品</div>
      <div class="product-row">
        <div style="flex:1; text-align:center;">商品名稱
          <input id="newName" placeholder="名稱">
        </div>
        <div style="flex:1; text-align:center;">成本
          <input id="newCost" type="number" placeholder="成本">
        </div>
        <div style="flex:1; text-align:center;">售價
          <input id="newPrice" type="number" placeholder="售價">
        </div>
      </div>
      <button onclick="addProduct()" style="margin-top:6px;">新增商品</button>
    </div>
  </div>

</div>

<script>
let userCode = "";
const adminPassword="1234";
let products=[], sales=[];

// ---------------- 登入 ----------------
function login(){
  const code = document.getElementById("userCodeInput").value.trim();
  if(!code){ alert("請輸入代號"); return; }
  userCode = code;
  document.getElementById("loginCard").style.display="none";
  document.getElementById("mainScreen").style.display="block";
  fetchProducts();
  fetchSalesFromSheet();
  setInterval(fetchSalesFromSheet, 5000); // 每5秒刷新
}

// ---------------- 本地測試商品 (可改為 Google Sheet 讀取) ----------------
function fetchProducts(){
  products = [
    {name:"雞蛋糕",cost:20,price:50},
    {name:"奶酪杯",cost:25,price:60},
    {name:"提拉米蘇杯",cost:30,price:70},
    {name:"雪媚娘",cost:25,price:55},
    {name:"紅糖糍粑",cost:15,price:40},
    {name:"奶茶凍",cost:20,price:50},
    {name:"桂花奶酪",cost:25,price:60},
    {name:"華夫餅",cost:30,price:65}
  ];
  updateSelect();
}

// ---------------- 更新商品下拉選單 ----------------
function updateSelect(){
  const s=document.getElementById("productSelect");
  s.innerHTML="";
  products.forEach((p,i)=>{
    const o=document.createElement("option");
    o.value=i;
    o.textContent=p.name;
    s.appendChild(o);
  });
}

// ---------------- 新增銷售 ----------------
function addSale(){
  const d=document.getElementById("dateInput").value;
  const i=document.getElementById("productSelect").value;
  const q=parseInt(document.getElementById("qtyInput").value);
  if(!d||q<=0) return;

  const productObj = products[i];
  const saleData = { 
    date: d, 
    product: productObj.name, 
    qty: q, 
    price: productObj.price,
    user: userCode 
  };

  fetch("YOUR_WEB_APP_URL", {
    method: "POST",
    body: JSON.stringify(saleData),
    headers: { "Content-Type": "application/json" }
  })
  .then(res=>res.json())
  .then(data=>{
    if(data.status==="success"){ fetchSalesFromSheet(); }
    else alert("傳送失敗：" + data.msg);
  })
  .catch(err=>alert("傳送錯誤：" + err));
}

// ---------------- 讀取 Google Sheet 銷售 ----------------
function fetchSalesFromSheet(){
  fetch("https://script.google.com/macros/s/AKfycbwR9gETJY8xZWxV1yiT2SbufwvTPydCznxVxxzHcfO6QfeJOqVE0qCMtJn5Dew44TJaxA/exec")
    .then(res => res.json())
    .then(data => {
      if(Array.isArray(data)){
        sales = data;
        renderSales();
      }
    })
    .catch(err => console.log("讀取錯誤:", err));
}

// ---------------- 顯示銷售表格 ----------------
function renderSales(){
  const list=document.getElementById("salesList");
  list.innerHTML="";
  let cost=0, rev=0;
  sales.forEach((s, idx)=>{
    const r = s.price*s.qty;
    cost += products.find(p=>p.name===s.product)?.cost * s.qty || 0;
    rev += r;
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${s.date.slice(5)}</td>
                   <td>${s.product}</td>
                   <td>${s.qty}</td>
                   <td>${r}</td>
                   <td>${s.user}</td>
                   <td><button onclick="delSale(${idx})">刪除</button></td>`;
    list.appendChild(tr);
  });
  document.getElementById("totalCost").textContent=cost;
  document.getElementById("totalRevenue").textContent=rev;
  document.getElementById("totalProfit").textContent=rev-cost;
}

// ---------------- 後台 ----------------
function unlockBackend(){
  if(document.getElementById("adminPwd").value===adminPassword){
    document.getElementById("backend").style.display="block";
  } else alert("密碼錯誤");
}

function renderBackend(){
  const box=document.getElementById("productList");
  box.innerHTML="";
  products.forEach((p,i)=>{
    const d=document.createElement("div");
    d.className="product-card";
    d.innerHTML=`<div style="margin-bottom:6px; font-weight:bold;">${p.name}</div>
    <div class="product-row">
      <div style="flex:1; text-align:center;">成本<input value="${p.cost}" onchange="updateP(${i},'cost',this.value)"></div>
      <div style="flex:1; text-align:center;">售價<input value="${p.price}" onchange="updateP(${i},'price',this.value)"></div>
    </div>
    <button onclick="delProduct(${i})" style="margin-top:6px;">刪除商品</button>`;
    box.appendChild(d);
  });
}

function updateP(i,f,v){ products[i][f]=parseFloat(v); updateSelect(); renderSales(); }
function delProduct(i){ products.splice(i,1); updateSelect(); renderBackend(); renderSales(); }
function addProduct(){
  const n=newName.value;
  const c=parseFloat(newCost.value);
  const p=parseFloat(newPrice.value);
  if(!n||!c||!p) return;
  products.push({name:n,cost:c,price:p});
  updateSelect(); renderBackend();
  newName.value=newCost.value=newPrice.value="";
}

updateSelect(); renderSales(); renderBackend();
</script>

</body>
</html>
